PLIP 8802: Move our upgrade / migration infrastructure to GenericSetup
======================================================================

External review by Hanno Schlichting <hannosch>.

PLIP was reviewed on Mac OS X 10.6 using Python 2.6.2 (64-bit).

Review steps
------------

- Did a manual review of the code in Plone (migration tool).

- Did a manual review of all code in plone.app.upgrade.

- Created a stock Plone 2.5 Data.fs, copied it into a Plone 4.0 site and ran
  the upgrade. Poked around the UI and did all the common editing and site
  admin operations.

- Created a full GenericSetup export of an upgraded 2.5 site and compared it
  to a pristine export for a Plone 4.0 site. The result is in the
  `plip8802-review-hannosch-changes.diff` file.

- TODO: Missing review step: Do an upgrade of a Plone 3.0 site and compare.

Notes and observations
----------------------

- The GenericSetup Upgrades tab is pretty unfriendly. We should consider to
  let it display the currently active baseline profiles per default (thus
  making it CMFPlone:plone) and not CMFDefault. We should also mark the
  CMFDefault upgrade steps as being run (manually setting its profile version
  to 2.2 instead of unknown). That should help avoid some confusion of people
  trying to run those steps.

- When upgrading from Plone 2.5, the Kupu control panel is named
  "Kupu visual editor" and in the add-ons section. It should be "Visual Editor"
  and be in the "Plone Configuration" section. "Workflow policies" is missing
  its icon.

- The markup control panel points to "@@language-controlpanel".

- In a site upgraded from 2.5, inline editing is enabled. We could be smarter
  and disable it for these sites. For sites starting out from Plone 3.0 we
  wouldn't touch the value.

- placeful_workflow_configuration.pt throws an error for document_byline as
  found in "here/document_byline/macros/byline"

- The workflow drop-down tries to do KSS actions, but nothing happens. The KSS
  error console in Firebug shows a NotFound error for the content_status_modify
  script. Invoking the script manually works.

- Doing a full GenericSetup export of all steps, throws an AttributeError on
  image_types for the ATCT tool step. Via:
  Products.ATContentTypes.exportimport.atcttool, line 165, in exportATCTTool
  ...
  Products.ATContentTypes.exportimport.atcttool, line 27, in _exportNode
  ...
  Module OFS.PropertyManager, line 151, in getProperty

  Looking at the ZMI screen of the ATCT tool, the properties are present but
  lack the checkbox in front. The tool has no _properties in its __dict__. So
  the properties registrations are missing.

- When attempting to do an upgrade for a Plone 2.1 site, Zope starts fine.
  Accessing anything inside the Plone site (ZMI or public site) throws the
  following error: "'GroupUserFolder' object is not iterable". We should
  document this, so it can be found via Google and tell people about the proper
  two-step upgrade procedure.

- Looking at the `plip8802-review-hannosch-changes.diff` there quite a number
  of differences. Most of these are probably not the fault of this PLIP but
  already happened earlier. The lines prefixed with a minus are things missing
  in an upgraded site. The plus lines are things which only exist in an
  upgraded site.

  Typical examples of forgotten upgrades include the missing installation of
  ATRelativePathCriterion, various missing properties and spurious extra
  aliases or actions (content_status_history) on types.

  TODO for the reviewer: The changes in the CSS and JS registries and the
  control panel entries need some further cleanup, before one can see what the
  actual changes are.

  NOTE: The diff file is altered manually quite a bit to take out some
  intentional differences already.

Conclusions
-----------

Not finished yet likely going to be: +1

The use of the upgrade machinery stays the same and the new upgrade step
registrations make things more similar to add-ons and can serve as examples to
those.

There are quite a number of differences in the generated diff, though. These
should be looked at. I'd not blame that on the PLIP author alone ;)
