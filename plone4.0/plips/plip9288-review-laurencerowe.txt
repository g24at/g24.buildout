PLIP 9288: Improved commenting infrastructure
=============================================

Plip ticket: https://dev.plone.org/plone/ticket/9288

Review #1 by Laurence Rowe (laurence@lrowe.co.uk, elro on irc)

The PLIP was reviewed on Mac OS X 10.5.8 using python 2.6.1 and Firefox 3.5.3.

Review steps
------------

- Run buildout with plip9288-improved-commenting-infrastructure.cfg

- Started instance, created site with Plone Discussions extension profile enabled.

- Enabled commenting on front-page

1. Simple commenting
--------------------

 - Added a comment to the front-page. Added another by clicking Reply.

 - In Discussion control panel disabled 'Show commenter image', observed that no commenter image was shown on front-page.

2. Moderated commenting
-----------------------

 - In types control panel switched to the 'Comment review workflow' for Comment portal type.

 - On adding a new comment the following insufficient privileges error was shown:

{{{
Traceback (innermost last):
  Module ZPublisher.Publish, line 127, in publish
  Module ZPublisher.mapply, line 77, in mapply
  Module ZPublisher.Publish, line 47, in call_object
  Module Shared.DC.Scripts.Bindings, line 324, in __call__
  Module Shared.DC.Scripts.Bindings, line 361, in _bindAndExec
  Module Products.CMFCore.FSPageTemplate, line 240, in _exec
  Module Products.CMFCore.FSPageTemplate, line 180, in pt_render
  Module Products.PageTemplates.PageTemplate, line 80, in pt_render
  Module zope.pagetemplate.pagetemplate, line 115, in pt_render
  Module zope.tal.talinterpreter, line 271, in __call__
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 888, in do_useMacro
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 533, in do_optTag_tal
  Module zope.tal.talinterpreter, line 518, in do_optTag
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 954, in do_defineSlot
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 533, in do_optTag_tal
  Module zope.tal.talinterpreter, line 518, in do_optTag
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 858, in do_defineMacro
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 954, in do_defineSlot
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 533, in do_optTag_tal
  Module zope.tal.talinterpreter, line 518, in do_optTag
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 531, in do_optTag_tal
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 742, in do_insertStructure_tal
  Module Products.PageTemplates.Expressions, line 195, in evaluateStructure
  Module zope.tales.tales, line 696, in evaluate
   - URL: file:/data/devel/plone/4.0/src/Plone/Products/CMFPlone/skins/plone_templates/main_template.pt
   - Line 150, Column 22
   - Expression: <StringExpr u'plone.belowcontent'>
   - Names:
      {'container': <PloneSite at /commenting>,
       'context': <ATDocument at /commenting/front-page>,
       'default': <object object at 0x30e550>,
       'here': <ATDocument at /commenting/front-page>,
       'loop': {},
       'nothing': None,
       'options': {'args': ()},
       'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x5b0fe68>,
       'request': <HTTPRequest, URL=http://localhost:8080/commenting/front-page/document_view>,
       'root': <Application at >,
       'template': <FSPageTemplate at /commenting/document_view used for /commenting/front-page>,
       'traverse_subpath': [],
       'user': <PropertiedUser 'admin'>}
  Module zope.contentprovider.tales, line 80, in __call__
  Module plone.app.viewletmanager.manager, line 151, in render
  Module plone.app.viewletmanager.manager, line 83, in render
  Module plone.app.layout.viewlets.common, line 45, in render
  Module Products.Five.browser.pagetemplatefile, line 126, in __call__
  Module Products.Five.browser.pagetemplatefile, line 60, in __call__
  Module zope.pagetemplate.pagetemplate, line 115, in pt_render
  Module zope.tal.talinterpreter, line 271, in __call__
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 852, in do_condition
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 533, in do_optTag_tal
  Module zope.tal.talinterpreter, line 518, in do_optTag
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 852, in do_condition
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 821, in do_loop_tal
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 533, in do_optTag_tal
  Module zope.tal.talinterpreter, line 518, in do_optTag
  Module zope.tal.talinterpreter, line 513, in no_tag
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 852, in do_condition
  Module zope.tal.talinterpreter, line 343, in interpret
  Module zope.tal.talinterpreter, line 405, in do_startTag
  Module zope.tal.talinterpreter, line 482, in attrAction_tal
  Module Products.PageTemplates.Expressions, line 202, in evaluateText
  Module zope.tales.tales, line 696, in evaluate
   - URL: /data/devel/plone/4.0/src/plone.app.discussion/plone/app/discussion/browser/comments.pt
   - Line 62, Column 20
   - Expression: <PathExpr standard:u'reply/title'>
   - Names:
      {'args': (),
       'container': <ATDocument at /commenting/front-page>,
       'context': <ATDocument at /commenting/front-page>,
       'default': <object object at 0x30e550>,
       'here': <ATDocument at /commenting/front-page>,
       'loop': {},
       'nothing': None,
       'options': {},
       'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x5b196c0>,
       'request': <HTTPRequest, URL=http://localhost:8080/commenting/front-page/document_view>,
       'root': <Application at >,
       'template': <Products.Five.browser.pagetemplatefile.ViewPageTemplateFile object at 0x36040d0>,
       'traverse_subpath': [],
       'user': <PropertiedUser 'admin'>,
       'view': <Products.Five.viewlet.metaconfigure.CommentsViewlet object at 0x5b07db0>,
       'views': <Products.Five.browser.pagetemplatefile.ViewMapper object at 0x5ab2770>}
  Module zope.tales.expressions, line 217, in __call__
  Module Products.PageTemplates.Expressions, line 127, in _eval
  Module zope.tales.expressions, line 124, in _eval
  Module Products.PageTemplates.Expressions, line 76, in boboAwareZopeTraverse
  Module OFS.Traversable, line 310, in restrictedTraverse
  Module OFS.Traversable, line 245, in unrestrictedTraverse
   - __traceback_info__: ([], 'title')
Unauthorized: You are not allowed to access 'title' in this context
}}}


Notes and observations
----------------------

 - I wonder if the 'Add comment' form should be hidden by default and revealed by js when clicking the Comment button, similar to how the Reply button works.


General design
--------------

 - I've not looked into detail at the implementation. Without actually writing some custom commenting code, it is difficult to know whether the extension points are in appropriate places. It seems sane though.

Conclusion
----------

There remain a number of items in TODO.txt and KNOWN_ISSUES.txt. These would need to be addressed before merging.

Basic performance testing should be done on a page with 0, 10, 100 comments.
