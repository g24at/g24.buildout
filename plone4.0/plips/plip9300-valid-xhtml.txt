PLIP 9300 Valid XHTML
=====================

This PLIP is in progress

PLIP ticket: http://dev.plone.org/plone/ticket/9300

'valid' means that XHTML validates against Plone 4's professed DTD: 
http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd


Objectives
----------
1. Every page of a default Plone 4 instance will validate
2. Product developers will have access to a test which enables them to easily validate the pages 
   that result from their products.
3. Automated testing of Plone will include validating its output.


Work done so far
----------------
As Kupu is the cause of most errors, and because it is to be replaced by TinyMCE, we used
TinyMCE in this buildout. This removed most validation errors and allowed us to focus. We 
created:

http://svn.plone.org/svn/collective/plone.validationtestcase/branches/plip9300-valid-xhtml/ 

This extends PloneTestCase.FunctionalTestCase to validate the output of Plone pages 
against their declared doctype dtd. It validates against a local copy of the W3C DTD 
rather than downloading a copy from the W3C. User agent header can be set as some products
may render different HTML (this was the case for Kupu, and hopefully isn't the case 
elsewhere). Creates an admin user and logs in to validate admin pages, most of the validation 
errors are on these pages. 

./bin/test -s plone.validationtestcase

We knew of troublesome pages by validating with the W3C markup validation service: 
http://validator.w3.org/ Identifying problem pages with this tool, we then added them to the
tests so that our fixes were test driven. Our validator caught the same errors as the W3C 
(though would only ever report just the first).

We then tracked down the products responsible for the errors, branched them, and fixed the
errors:


Summary of changes
------------------

Products.ATReferenceBrowserWidget
 - Prevented empty UL elements.

plone.app.layout
 - Removed the xhtml xml namespace from viewlets as we don't want duplicated namespaces declared 
   in the final rendered page.

Products.Archetypes
 - Ensured label 'for' attributes pointed to correct archetype field 'id' attributes
   Removed proprietary 'wrap' attribute from textarea, adding this instead with JavaScript. (I don't 
   really like the inline JavaScript, but it's arguably preferable to invalid code. Ideally this 
   would all happen in external files -- along with inline CSS -- but that could be another PLIP)

plone.app.controlpanel
 - Removed noscript blocks, not valid where positioned, and replaced with script which achieves the 
   same purpose: hide buttons for clients with JavaScript. See note above on inline JavaScript. 
 - Closed empty elements (added '/')
 - Changed a label's 'for' attribute to reference the 'id' attribute of its target input element


zope.app.form
 - Identified as the cause of invalid markup on @@calendar-controlpanel -- there are 43 validation 
   errors  on this page. As of yet, I have not had time to fix these. My intention is to save a diff 
   of my changes unless I can be granted zope commit rights


Work still to do
----------------
By its nature this PLIP cannot be finished in Plone 4.0. Until other PLIPs have been accepted, I 
can't be sure of the code I am validating. For example, I've been asked to use 
archetypes.referencebrowserwidget after my commit for Products.ATReferenceBrowserWidget was noticed, 
as this will be used in Plone 4. I'm happy to do this but it illustrates that this effort needs to 
be ongoing.

plone.validationtestcase
 - Make admin login optional
 - Is there a way to report on more than just the first error?
 - Create a crawler to crawl the site (work on this was started in branches/crawler, we 
   need to think about how we are crawling, by hrefs? From the catalogue?)
 - Integrate into Plone's nightly testing (either crawling the site or at least visiting all 
   the default pages from a hard-coded list)
 - Get the product tidied up and well documented so that product developers may be encouraged to use
   it as part of there product testing
   
Validation
 - Continue to fix the products in Plone and Zope responsible for validation errors.


Credits
-------
Ben Glynn
Matt Hamilton
Adam Alton 
Ryan Northey

