PLIP 9309: Better search for East Asian (multi-byte) languages
==============================================================

PLIP ticket: http://dev.plone.org/plone/ticket/9309

Review #1 by Vincent Fretin (vincent.fretin@gmail.com)

The PLIP was reviewed on Ubuntu 8.10 using Python 2.5.2 and Firefox 3.0.14
without sitecustomize.py.


Review steps
------------

- Run buildout WITHOUT the plip9309-unicode-splitter-patch.cfg file.

- Start the instance an create 2 pages

Create a 1st page (Japanese) with
Title:今日は
Description:ありがとうございます

Create a second page (French) with
Title:œil
Description:sœur éléphant
For this page, there is no changes when I search for it, its the same behavior in both case.

I searched the following with the search form, not the livesearch.

今
returns nothing

今日
returns nothing

今日*
returns the page
If you search "今日" in the livesearch, it searches in reality "今日*"
The livesearch append "*" automatically.

今日は
returns the page

ありがとう
returns nothing

ございます
returns nothing

ありがとうございます
returns the page


- Run buildout using the plip9309-unicode-splitter-patch.cfg file.

Delete and create the pages again
and do the tests again:

今
returns the page

今日
returns the page

今日*
returns nothing. That's not ok here.
If you search "今日" in the livesearch, it searches in reality "今日*"
The livesearch append "*" automatically.

今日は
returns the page

ありがとう
returns the page

ございます
returns the page

ありがとうございます
returns the page

any kanji or hiragana will returns the page. This is what we want.

- Run Products.UnicodeSplitterPatch tests with
  bin/instance test -s Products.UnicodeSplitterPatch
  Ran 16 tests with 0 failures and 0 errors in 0.527 seconds.

- Visual review of the Products.UnicodeSplitterPatch code and 
  review the difference between the monkey patch and the original method for Lexicon.

2009-10-03:
- Run tests with
  bin/instance test -s Products.CMFPlone
  bin/instance test -s Zope2

- Visual review of the Zope2 and Plone branch


Notes and observations
----------------------
For me the PLIP is not completed.
The PLIP should not be written as a monkey patch,
The changes should be in branches of Products.CMFPlone and Zope2 packages.

Products.UnicodeSplitterPatch patches:
Zope2/src/Products/ZCTextIndex/Lexicon.py:Lexicon.termToWordIds
Products.CMFPlone/Products/CMFPlone/UnicodeSplitter.py:Splitter

For the Lexicon change. The monkey patch patches the termToWordIds method to
replace the line:
last = element.process(last)
by:
process = getattr(element, "process_post_glob", element.process)
last = process(last)

In config.py
rx_U and rxGlob_U are the same as the one in Products.CMFPlone/Products/CMFPlone/UnicodeSplitter.py

In the original implementation
Products.CMFPlone/Products/CMFPlone/UnicodeSplitter.py:Splitter.process
if an UnicodeDecodeError is raised, then rx_L is used, which is a regexp with re.LOCAL option.
In the new implementation, we can't have an UnicodeDecodeError, because we use
x.decode(enc, "replace") 
But I'm not sure about the difference in the processing of non utf-8 strings here.

About the performance of non East Asian language,
there is a regexp match for each word indexed as far as I can tell.
If the regexp matches an East Asian language, then you go to the bigrams algorithm.

2009-10-03:
The current code is implemented with two branches.
The implementation reintroduce rx_L regexp as fallback in case of DecodeError
The code is much more readable, functions have doctrings.
The livesearch issue is fixed for Japanese.


Conclusion
----------

With this new implementation, the search form works better for Japanese.
But the livesearch is broken for Japanese, you got no results no matter what you search.
This new implementation should be rewritten to not use monkey patching at all,
but providing branches for Products.CMFPlone and Zope2.

Guest FWT vote: -1

2009-10-03:
With this new implementation, all the previous issues found in the first review are fixed.

Guest FWT vote: +1
