PLIP 9327: Unified interface for lists of content
=================================================

PLIP ticket: http://dev.plone.org/plone/ticket/9327

Review #1 by David Glick (dglick@gmail.com, davisagli on irc)

The PLIP was reviewed on Mac OS X 10.5.7 using python 2.6 and Firefox 3.5.2.


Review steps
------------

- Run buildout using the plip9327-contentlisting.cfg file.

- Visual review of the code in plone.app.contentlisting

- Run bin/instance test -s plone.app.contentlisting

- Benchmarked the p.a.contentlisting-based search results from PLIP #9352's
  plone.app.search in comparison to the old search.pt


Notes and observations
----------------------

* I like the basic concept and the simplicity of the interfaces and browser
  views included.

* It would be useful to see an example of how one of the existing folder
  listing templates would be rewritten to use this PLIP, even if actually
  switching Plone to that new implementation is out of scope for the initial
  merge.  This would make it easier to judge whether this package succeeds
  in simplifying things without making them harder to customize.

* Automatically doing a getObject and attribute lookup if the attribute is not
  found in the catalog brain is a neat trick, but I'm not sure how I feel about
  it as a default.  Our current approach makes it obvious that you're doing 
  something different, which makes it easier to set expectations about
  performance implications of waking up lots of objects.

* The FolderListing browser view does a permission check of 'Access inactive
  portal content' which is then not used anywhere.

* Why do CatalogContentListingObject's date-related accessors take a 'zone'
  parameter that is unused? (Update 9/9/09 -- This is how the interface
  is defined.)

* It might be nice for CatalogContentListingObject's string representation to
  include the result of its getPath method, as a debugging aid.  (Update
  9/9/09 -- this is done.)

* plone.app.contentlisting contains a set of doctests which pass, but test
  coverage of the browser and catalog modules is only about 60%.

* (NOTE: This point is out of date -- see addendum below.)
  I tried to get a rough benchmark of plone.app.contentlisting vs. a more
  classic approach to listing content by benchmarking the new search results
  view in PLIP #9352, which is based on plone.app.contentlisting.
  Specifically, I did the following:
  
  * used collective.contentgenerator's Public Site profile to populate the site
    with 4000 items
  * used ab -n 100 to benchmark the old search results
    (/search?SearchableText=Britain&b_size=2000) and the new ones
    (/@@search?SearchableText=Britain&b_size=2000) -- the large batch size here
    is because the new results don't support batching yet...in my case the
    search for 'Britain' gave about 500 results.

  Performance results:
    * old search.pt: 6.32 requests/sec.
    * new search browser view: 1.09 requests/sec. Ouch.

  (Caveat: I haven't done detailed profiling to confirm that p.a.contentlisting
  is the reason for the decrease in performance here.  But it seems plausible
  to me, and I think it is the PLIP authors' responsibility to prove me wrong.)


Conclusion
----------

This looks promising, but my FWT vote is -1 unless the performance can be
improved.  It's unfortunate that this also has implications for the search
results and collection PLIPs, which have been based on
plone.app.contentlisting.


Addendum, 8/31/09
=================

I just realized that my benchmark of the search pages was incorrect, and added
a note about that at http://dev.plone.org/plone/ticket/9352#comment:14

The upshot is that with batching accounted for properly, it looks like the
content listing implementation from this package will still perform about 15%
slower than the existing non-adapter-based approach.

I'm still a bit concerned about even a 15% slowdown, given that the #1 feature
request we have on plone.uservoice.com right now is "Improve overall speed,"
and given that content listings are an important and not very trivially
cachable part of most sites.

I'm also concerned that this doesn't help much with reducing complexity.  The main
pain that I've heard about from integrators regarding content listings is the
fact that they have to customize a number of different listing templates to
change the way a particular content type shows up in listings.  This PLIP
doesn't really help with that.  The fact that it's not actually being used for
all listings is also a minus for integrators, since it means that they'll need
to do one thing to customize search or collection results (assuming the
corresponding PLIPs are accepted) but another to customize folder listing views.

So I guess my vote remains at -1.

Addendum, 9/9/09
================

Geir has done some additional work on performance and the new view is now faster.

 - old: 7.27 req/sec.
 - new: 7.58 req/sec. (4% faster)

Geir also said, "Note that i am willing to convert most of the existing listings
to use this interface so things'll be coherent."

This addresses my biggest two concerns about this PLIP, so my FWT vote is now
+1, assuming the other listings are successfully converted.  I would like to
see that work happen on a branch and have another chance to look it over before
it gets merged.
