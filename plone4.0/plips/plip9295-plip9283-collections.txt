PLIP 9283: A more lightweight backend for collections && PLIP 9295: Improved UI for Collections 
===============================================================================================

This plip is ready for review.

Improved UI for Collections:
Plip ticket: https://dev.plone.org/plone/ticket/9295

A more lightweight backend for collections:
Plip ticket: https://dev.plone.org/plone/ticket/9283

TTW-testing
---------------
Install plone.app.collection with the add/remove products panel.
Add a collection (you can see the difference from old-style collections with the new icon.)
Edit criteria and see searchresults be updated.



To do
-----

- UI Widgets improvements.
- i18n / l10n.
- Tests.
- Error handling.

Future plans
------------

- Store the configuration settings in plone.registry / create control panel.
- Create a collection portlet.
- Create a querystringwidget for Archetypes.

Summary of changes
------------------

- Added new collection type.
- Added querystring builder.
- Added querystring parser.
- New view templates.
- New collection criteria UI.

Needed documentation changes
----------------------------

- New user manual for adding collections.
- New backend documentation will be needed for customizing indexes.

Backwards compatibility
-----------------------

- New content type. No automatic migration, yet.

Known issues
------------

- Some small javascript issues in Safari
- Small styling issues with the criteria edit form.

Credits
-------

Laurens Kling
Geir Baekholt
Ralph Jacobs
Roel Bruggink
Rob Gietema
Denys Mishunov

Review of UI (9295)
-------------------

Let me start off by saying that I'm very excited about this PLIP. Our current
Collections UI is utterly unusable and, as you point out, your work could both
fix that and greatly improve the advanced search, comprising a major part of
Plone's user-facing functionality. Thus, I'm going to be very picky in this
review, not because I don't want this to make it in--I do--but because I want it
to be a great success.

- I'd like to see less clicking and more mutability in the UI. Your original
  mockups looked great
  (https://dev.plone.org/old/plone/raw-attachment/ticket/9295/Picture%208.png),
  evoking the old Sherlock search utility
  (http://www.sapdesignguild.org/community/images/Sherlock.gif). Why did you
  deviate from them? Following them more closely would give you less user
  confusion (though I'm willing to bow to user tests showing otherwise), the
  ability to change comparators (like "contains"/"does not contain") without
  wiping out entire clauses, and simply less clicking for common clauses (which
  things should default to). Also, because your original mockups would
  presumably add only entire clauses at a time, you'd have fewer invalid states
  to deal with when people hit Save.

- It's not obvious to me what to do with the date widget. Should I type m/d/yy
  into it? d-m-yyyy? Either a hold-my-hand widget or an example (perhaps greyed,
  within the field, disappearing when the control is focused) would help.

- "is" and "is not" might be less computer-jargonny (and shorter) ways of
  saying "equals" and "does not equal".

- A crasher:

    1. Make a new Collection in a new Plone site.
    1. On the Criteria tab, choose Effective Date, and click Add Criteria.
    1. Choose "on", and click Add Criteria.
    1. Click Remove. Kaboom::
    
        2009-09-02 13:17:39 ERROR Zope.SiteErrorLog 1251911859.940.183495066765 http://127.0.0.1:8080/p1/c2/criterion_edit_form
        Traceback (innermost last):
          Module ZPublisher.Publish, line 127, in publish
          Module ZPublisher.mapply, line 77, in mapply
          Module ZPublisher.Publish, line 47, in call_object
          Module Products.Five.browser.metaconfigure, line 427, in __call__
          Module Products.Five.browser.pagetemplatefile, line 126, in __call__
          Module Products.Five.browser.pagetemplatefile, line 60, in __call__
          Module zope.pagetemplate.pagetemplate, line 115, in pt_render
          Module zope.tal.talinterpreter, line 271, in __call__
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 888, in do_useMacro
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 533, in do_optTag_tal
          Module zope.tal.talinterpreter, line 518, in do_optTag
          Module zope.tal.talinterpreter, line 513, in no_tag
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 954, in do_defineSlot
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 533, in do_optTag_tal
          Module zope.tal.talinterpreter, line 518, in do_optTag
          Module zope.tal.talinterpreter, line 513, in no_tag
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 858, in do_defineMacro
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 954, in do_defineSlot
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 533, in do_optTag_tal
          Module zope.tal.talinterpreter, line 518, in do_optTag
          Module zope.tal.talinterpreter, line 513, in no_tag
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 946, in do_defineSlot
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 742, in do_insertStructure_tal
          Module Products.PageTemplates.Expressions, line 195, in evaluateStructure
          Module zope.tales.tales, line 696, in evaluate
           - URL: /Users/erikrose/Zope/4-ploneout/src/plone.app.collection/plone/app/collection/browser/templates/criterion_edit_form.pt
           - Line 576, Column 4
           - Expression: <PathExpr standard:u'view/previewSearchResults'>
           - Names:
              {'args': (),
               'container': <Collection at /p1/c2>,
               'context': <Collection at /p1/c2>,
               'default': <object object at 0x16538>,
               'here': <Collection at /p1/c2>,
               'loop': {},
               'nothing': None,
               'options': {},
               'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x5606300>,
               'request': <HTTPRequest, URL=http://127.0.0.1:8080/p1/c2/criterion_edit_form>,
               'root': <Application at >,
               'template': <Products.Five.browser.pagetemplatefile.ViewPageTemplateFile object at 0x3777d10>,
               'traverse_subpath': [],
               'user': <PropertiedUser 'admin'>,
               'view': <Products.Five.metaclass.SimpleViewClass from /Users/erikrose/Zope/4-ploneout/src/plone.app.collection/plone/app/collection/browser/templates/criterion_edit_form.pt object at 0x58ee450>,
               'views': <Products.Five.browser.pagetemplatefile.ViewMapper object at 0x56c93b0>}
          Module zope.tales.expressions, line 217, in __call__
          Module Products.PageTemplates.Expressions, line 135, in _eval
          Module Products.PageTemplates.Expressions, line 99, in render
          Module plone.app.search.browser, line 119, in previewSearchResults
          Module Products.Five.browser.metaconfigure, line 427, in __call__
          Module Products.Five.browser.pagetemplatefile, line 126, in __call__
          Module Products.Five.browser.pagetemplatefile, line 60, in __call__
          Module zope.pagetemplate.pagetemplate, line 115, in pt_render
          Module zope.tal.talinterpreter, line 271, in __call__
          Module zope.tal.talinterpreter, line 343, in interpret
          Module zope.tal.talinterpreter, line 583, in do_setLocal_tal
          Module zope.tales.tales, line 696, in evaluate
           - URL: /Users/erikrose/Zope/4-ploneout/src/plone.app.search/plone/app/search/previewsearchresults.pt
           - Line 11, Column 0
           - Expression: <PathExpr standard:u'view/results'>
           - Names:
              {'args': (),
               'container': <Collection at /p1/c2>,
               'context': <Collection at /p1/c2>,
               'default': <object object at 0x16538>,
               'here': <Collection at /p1/c2>,
               'loop': {},
               'nothing': None,
               'options': {},
               'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x54ce828>,
               'request': <HTTPRequest, URL=http://127.0.0.1:8080/p1/c2/criterion_edit_form>,
               'root': <Application at >,
               'template': <Products.Five.browser.pagetemplatefile.ViewPageTemplateFile object at 0x35dbf30>,
               'traverse_subpath': [],
               'user': <PropertiedUser 'admin'>,
               'view': <Products.Five.metaclass.SimpleViewClass from /Users/erikrose/Zope/4-ploneout/src/plone.app.search/plone/app/search/previewsearchresults.pt object at 0x5445690>,
               'views': <Products.Five.browser.pagetemplatefile.ViewMapper object at 0x5445c50>}
          Module zope.tales.expressions, line 217, in __call__
          Module Products.PageTemplates.Expressions, line 135, in _eval
          Module Products.PageTemplates.Expressions, line 99, in render
          Module plone.app.search.browser, line 81, in results
          Module plone.app.search.browser, line 100, in _queryForResults
          Module Products.CMFPlone.CatalogTool, line 313, in searchResults
          Module Products.ZCatalog.ZCatalog, line 656, in searchResults
          Module Products.ZCatalog.Catalog, line 737, in searchResults
          Module Products.ZCatalog.Catalog, line 476, in search
          Module Products.PluginIndexes.DateIndex.DateIndex, line 222, in _apply_index
        TypeError: expected integer key

- A surprising behavior:

    1. Make a new Collection in a new Plone site.
    1. On the Criteria tab, choose Description, and click Add Criteria.
    1. Choose "does not equal", and click Add Criteria.
    1. Type "fred" in the newly added field, and hit Return.
    1. Click after "fred", and hit Return again. Your clause disappears. If
       you had added other clauses before the Description, they disappear, too.
  
- Another bug: on the Criteria tab, the Reversed Order checkbox always reverts
  to checked when you click Save.

- The "n items remaining" text doesn't appear in WebKit-based browsers.

- The tabular view isn't. There's no way of specifying what columns to show in
  it. Is this planned? It's mighty popular among our clients.

In summary, the UI still needs some work before I'd be willing to +1 it for
Plone 4. However, I remain hopeful that it can be done in time! If I can be any
help, don't hesitate to contact me. --Erik Rose